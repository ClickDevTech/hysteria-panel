<div class="page-header sticky-header">
    <div class="page-header-left">
        <span class="results-count"><%= pagination.total %> <%= t('nav.users').toLowerCase() %></span>
    </div>
    <div class="page-header-center">
        <div class="filters-bar">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" id="searchUser" placeholder="<%= t('users.searchPlaceholder') %>" 
                       value="<%= query.search || '' %>" autocomplete="off">
                <kbd class="search-hint">/</kbd>
            </div>
            <select id="filterEnabled" class="filter-select">
                <option value=""><%= t('users.allStatuses') %></option>
                <option value="true" <%= query.enabled === 'true' ? 'selected' : '' %>><%= t('users.activeFilter') %></option>
                <option value="false" <%= query.enabled === 'false' ? 'selected' : '' %>><%= t('users.inactiveFilter') %></option>
            </select>
            <select id="filterGroup" class="filter-select">
                <option value=""><%= t('users.allGroups') %></option>
                <% if (groups) { groups.forEach(group => { %>
                <option value="<%= group._id %>" <%= query.group === group._id.toString() ? 'selected' : '' %>><%= group.name %></option>
                <% }); } %>
            </select>
        </div>
    </div>
    <div class="page-header-right">
        <a href="/panel/users/add" class="btn btn-primary">
            <span>+</span> <%= t('common.create') %>
        </a>
    </div>
</div>

<div class="card users-table-card">
    <div class="table-wrapper">
        <table class="table" id="usersTable">
            <thead>
                <tr>
                    <th class="th-user sortable" onclick="sortBy('userId')" style="cursor: pointer;">
                        <%= t('users.user') %> <%= getSortIcon('userId') %>
                    </th>
                    <th class="th-status"><%= t('common.status') %></th>
                    <th class="th-groups"><%= t('users.groups') %></th>
                    <th class="th-traffic sortable" onclick="sortBy('traffic')" style="cursor: pointer;">
                        <%= t('users.traffic') %> <%= getSortIcon('traffic') %>
                    </th>
                    <th class="th-actions"><%= t('common.actions') %></th>
                </tr>
            </thead>
            <tbody>
                <% if (users.length === 0) { %>
                <tr>
                    <td colspan="5" class="empty-cell">
                        <div class="empty-state">
                            <span class="empty-icon">üë•</span>
                            <p><%= t('users.noUsers') %></p>
                            <a href="/panel/users/add" class="btn btn-primary btn-sm"><%= t('users.createFirst') %></a>
                        </div>
                    </td>
                </tr>
                <% } %>
                <% users.forEach(user => { %>
                <tr class="user-row" data-userid="<%= user.userId %>">
                    <td class="td-user">
                        <div class="user-info">
                            <code class="user-id"><%= user.userId %></code>
                            <% if (user.username) { %>
                            <span class="user-name"><%= user.username %></span>
                            <% } %>
                        </div>
                    </td>
                    <td class="td-status">
                        <label class="toggle-switch" title="<%= user.enabled ? t('users.disable') : t('users.enable') %>">
                            <input type="checkbox" <%= user.enabled ? 'checked' : '' %> 
                                   onchange="toggleUser('<%= user.userId %>', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </td>
                    <td class="td-groups">
                        <% if (user.groups && user.groups.length > 0) { %>
                            <% user.groups.slice(0,2).forEach(group => { %>
                                <span class="group-tag-sm" style="background: <%= group.color %>20; border-color: <%= group.color %>; color: <%= group.color %>">
                                    <%= group.name %>
                                </span>
                            <% }); %>
                            <% if (user.groups.length > 2) { %>
                                <span class="group-more">+<%= user.groups.length - 2 %></span>
                            <% } %>
                        <% } else { %>
                            <span class="text-muted">‚Äî</span>
                        <% } %>
                    </td>
                    <td class="td-traffic">
                        <% 
                        const used = ((user.traffic?.tx || 0) + (user.traffic?.rx || 0)) / (1024*1024*1024);
                        const limit = user.trafficLimit ? user.trafficLimit / (1024*1024*1024) : 0;
                        const percent = limit > 0 ? Math.min((used / limit) * 100, 100) : 0;
                        %>
                        <div class="traffic-info">
                            <span class="traffic-used"><%= used.toFixed(1) %> GB</span>
                        <% if (limit > 0) { %>
                            <div class="traffic-bar">
                                <div class="traffic-fill" style="width: <%= percent %>%"></div>
                            </div>
                            <span class="traffic-limit">/ <%= limit.toFixed(0) %> GB</span>
                            <% } else { %>
                            <span class="traffic-unlimited">‚àû</span>
                            <% } %>
                        </div>
                    </td>
                    <td class="td-actions">
                        <div class="action-buttons">
                            <button class="btn-icon" onclick="copySubscription('<%= user.subscriptionToken || user.userId %>')" title="<%= t('users.copySubscription') %>">
                                üìã
                            </button>
                            <a href="/panel/users/<%= user.userId %>" class="btn-icon" title="<%= t('users.details') %>">
                                ‚Üí
                            </a>
                        </div>
                    </td>
                </tr>
                <% }); %>
            </tbody>
        </table>
    </div>
    
    <!-- Mobile Cards -->
    <div class="mobile-users-list">
        <% if (users.length === 0) { %>
            <div style="text-align: center; padding: 40px 20px;">
                <p style="color: var(--text-muted); margin-bottom: 16px;"><%= t('users.noUsers') %></p>
                <a href="/panel/users/add" class="btn btn-primary btn-sm"><%= t('users.createFirst') %></a>
            </div>
        <% } %>
        <% users.forEach(user => { 
            const used = ((user.traffic?.tx || 0) + (user.traffic?.rx || 0)) / (1024*1024*1024);
            const limit = user.trafficLimit ? user.trafficLimit / (1024*1024*1024) : 0;
            const percent = limit > 0 ? Math.min((used / limit) * 100, 100) : 0;
        %>
            <div class="mobile-user-card" data-userid="<%= user.userId %>">
                <div class="mobile-node-header">
                    <div class="mobile-node-title">
                        <strong><%= user.userId %></strong>
                        <% if (user.username) { %>
                            <code style="font-size: 11px; color: var(--text-muted);"><%= user.username %></code>
                        <% } %>
                    </div>
                    <label class="toggle-switch" title="<%= user.enabled ? t('users.disable') : t('users.enable') %>">
                        <input type="checkbox" <%= user.enabled ? 'checked' : '' %> 
                               onchange="toggleUser('<%= user.userId %>', this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="mobile-node-stats">
                    <div class="mobile-stat-item">
                        <span class="mobile-stat-label"><%= t('users.traffic') %></span>
                        <span class="mobile-stat-value">
                            <%= used.toFixed(1) %> GB<% if (limit > 0) { %> / <%= limit.toFixed(0) %><% } else { %> ‚àû<% } %>
                        </span>
                    </div>
                    <div class="mobile-stat-item">
                        <span class="mobile-stat-label"><%= t('users.groups') %></span>
                        <span class="mobile-stat-value" style="font-size: 12px;">
                            <% if (user.groups && user.groups.length > 0) { %>
                                <%= user.groups.length %> <%= t('users.groupsCount') %>
                            <% } else { %>
                                ‚Äî
                            <% } %>
                        </span>
                    </div>
                </div>
                
                <% if (user.groups && user.groups.length > 0) { %>
                <div class="groups-list" style="margin-bottom: 12px;">
                    <% user.groups.slice(0,3).forEach(group => { %>
                        <span class="group-tag-sm" style="background: <%= group.color %>20; border-color: <%= group.color %>; color: <%= group.color %>">
                            <%= group.name %>
                        </span>
                    <% }); %>
                    <% if (user.groups.length > 3) { %>
                        <span class="group-more">+<%= user.groups.length - 3 %></span>
                    <% } %>
                </div>
                <% } %>
                
                <div class="mobile-node-actions">
                    <button class="btn btn-sm" onclick="copySubscription('<%= user.subscriptionToken || user.userId %>')" style="flex: 1;">
                        üìã <%= t('users.subscription') %>
                    </button>
                    <a href="/panel/users/<%= user.userId %>" class="btn btn-sm" style="flex: 1;">
                        <%= t('users.details') %>
                    </a>
                </div>
            </div>
        <% }); %>
    </div>
</div>

<% if (pagination.pages > 1) { %>
<div class="pagination">
    <% if (pagination.page > 1) { %>
    <a href="?page=<%= pagination.page - 1 %>&<%= Object.entries(query).filter(([k,v]) => k !== 'page' && v).map(([k,v]) => k+'='+v).join('&') %>" class="page-btn">‚Üê</a>
    <% } %>
    
    <% 
    let startPage = Math.max(1, pagination.page - 2);
    let endPage = Math.min(pagination.pages, pagination.page + 2);
    %>
    
    <% if (startPage > 1) { %>
    <a href="?page=1" class="page-btn">1</a>
    <% if (startPage > 2) { %><span class="page-dots">...</span><% } %>
    <% } %>
    
    <% for (let i = startPage; i <= endPage; i++) { %>
    <a href="?page=<%= i %>&<%= Object.entries(query).filter(([k,v]) => k !== 'page' && v).map(([k,v]) => k+'='+v).join('&') %>" 
       class="page-btn <%= pagination.page === i ? 'active' : '' %>"><%= i %></a>
    <% } %>
    
    <% if (endPage < pagination.pages) { %>
    <% if (endPage < pagination.pages - 1) { %><span class="page-dots">...</span><% } %>
    <a href="?page=<%= pagination.pages %>" class="page-btn"><%= pagination.pages %></a>
    <% } %>
    
    <% if (pagination.page < pagination.pages) { %>
    <a href="?page=<%= pagination.page + 1 %>&<%= Object.entries(query).filter(([k,v]) => k !== 'page' && v).map(([k,v]) => k+'='+v).join('&') %>" class="page-btn">‚Üí</a>
    <% } %>
</div>
<% } %>

<div id="toast" class="toast"></div>

<%
function getSortIcon(field) {
    const currentSort = query.sortBy || 'createdAt';
    const currentOrder = query.sortOrder || 'desc';
    
    if (currentSort !== field) {
        return '‚ÜïÔ∏è';
    }
    
    return currentOrder === 'desc' ? '‚Üì' : '‚Üë';
}
%>

<script>
const baseUrl = '<%= baseUrl %>';
const currentSortBy = '<%= query.sortBy || "createdAt" %>';
const currentSortOrder = '<%= query.sortOrder || "desc" %>';
const i18n = {
    turnedOn: '<%= t("users.turnedOn") %>',
    turnedOff: '<%= t("users.turnedOff") %>',
    error: '<%= t("common.error") %>',
    linkCopied: '<%= t("users.linkCopied") %>',
    copyError: '<%= t("users.copyError") %>'
};

// Debounced search
let searchTimeout;
document.getElementById('searchUser').addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => applyFilters(), 300);
});

// Keyboard shortcut: / to focus search
document.addEventListener('keydown', (e) => {
    if (e.key === '/' && document.activeElement.tagName !== 'INPUT') {
        e.preventDefault();
        document.getElementById('searchUser').focus();
    }
    if (e.key === 'Escape') {
        document.getElementById('searchUser').blur();
    }
});

// Filters
document.getElementById('filterEnabled').addEventListener('change', applyFilters);
document.getElementById('filterGroup').addEventListener('change', applyFilters);

function applyFilters() {
    const search = document.getElementById('searchUser').value.trim();
    const enabled = document.getElementById('filterEnabled').value;
    const group = document.getElementById('filterGroup').value;
    
    const params = new URLSearchParams();
    if (search) params.set('search', search);
    if (enabled) params.set('enabled', enabled);
    if (group) params.set('group', group);
    
    location.href = '/panel/users?' + params.toString();
    }

// Toggle user (optimistic update)
async function toggleUser(userId, enabled) {
    const row = document.querySelector(`tr[data-userid="${userId}"]`);
    const toggle = row.querySelector('.toggle-switch input');
    
    try {
    const res = await fetch(`/api/users/${userId}/${enabled ? 'enable' : 'disable'}`, {
        method: 'POST',
            credentials: 'include'
        });
        
        if (!res.ok) throw new Error('Failed');
        showToast(enabled ? i18n.turnedOn : i18n.turnedOff);
    } catch (e) {
        toggle.checked = !enabled; // Revert
        showToast(i18n.error, 'error');
    }
}

// Copy subscription
function copySubscription(token) {
    const url = `${baseUrl}/api/files/${token}`;
    navigator.clipboard.writeText(url).then(() => {
        showToast(i18n.linkCopied);
    }).catch(() => {
        showToast(i18n.copyError, 'error');
    });
}

// Toast
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast show ' + type;
    setTimeout(() => toast.className = 'toast', 2000);
}

// Sort by field
function sortBy(field) {
    const params = new URLSearchParams(window.location.search);
    
    if (currentSortBy === field) {
        const newOrder = currentSortOrder === 'desc' ? 'asc' : 'desc';
        params.set('sortOrder', newOrder);
    } else {
        params.set('sortBy', field);
        params.set('sortOrder', 'desc');
    }
    
    params.set('page', '1');
    
    location.href = '/panel/users?' + params.toString();
}
</script>
