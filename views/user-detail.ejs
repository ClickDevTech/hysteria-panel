<div class="page-header">
    <a href="/panel/users" class="btn btn-back"><%= t('common.backToList') %></a>
</div>

<div class="row">
    <div class="col-8">
        <div class="card">
            <div class="card-header">
                <h2><%= t('users.user') %> <%= user.userId %></h2>
                <span class="badge badge-<%= user.enabled ? 'success' : 'secondary' %> badge-lg">
                    <%= user.enabled ? t('common.active') : t('common.inactive') %>
                </span>
            </div>
            <div class="card-body">
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>User ID</label>
                        <code class="value"><%= user.userId %></code>
                    </div>
                    <div class="detail-item">
                        <label>Username</label>
                        <span class="value"><%= user.username || 'â€”' %></span>
                    </div>
                    <div class="detail-item">
                        <label><%= t('users.hysteriaPassword') %></label>
                        <code class="value"><%= user.password %></code>
                    </div>
                </div>
                
                <h3 class="section-title"><%= t('users.groups') %></h3>
                <div class="groups-list">
                    <% if (user.groups && user.groups.length > 0) { %>
                        <% user.groups.forEach(group => { %>
                            <span class="group-tag" style="background: <%= group.color %>20; border-color: <%= group.color %>; color: <%= group.color %>">
                                <%= group.name %>
                            </span>
                        <% }); %>
                    <% } else { %>
                        <span class="text-muted"><%= t('users.noGroupsAccess') %></span>
                    <% } %>
                </div>
                
                <h3 class="section-title"><%= t('users.limits') %></h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <label><%= t('users.traffic') %></label>
                        <% const used = ((user.traffic?.tx || 0) + (user.traffic?.rx || 0)) / (1024*1024*1024); %>
                        <% const limit = user.trafficLimit ? user.trafficLimit / (1024*1024*1024) : 0; %>
                        <span class="value"><%= used.toFixed(2) %> / <%= limit > 0 ? limit.toFixed(0) + ' GB' : 'âˆž' %></span>
                    </div>
                    <div class="detail-item">
                        <label><%= t('users.devices') %></label>
                        <% 
                            let deviceLimit = user.maxDevices;
                            let deviceLimitStr = 'âˆž';
                            if (deviceLimit === 0) {
                                const groupLimits = (user.groups || []).filter(g => g.maxDevices > 0).map(g => g.maxDevices);
                                if (groupLimits.length > 0) {
                                    deviceLimit = Math.min(...groupLimits);
                                    deviceLimitStr = deviceLimit + ' ' + t('users.deviceFromGroup');
                                }
                            } else if (deviceLimit > 0) {
                                deviceLimitStr = deviceLimit.toString();
                            }
                        %>
                        <span class="value"><%= deviceLimitStr %></span>
                    </div>
                    <div class="detail-item">
                        <label><%= t('users.txRx') %></label>
                        <span class="value">
                            â†‘ <%= ((user.traffic?.tx || 0) / (1024*1024*1024)).toFixed(2) %> / 
                            â†“ <%= ((user.traffic?.rx || 0) / (1024*1024*1024)).toFixed(2) %> GB
                        </span>
                    </div>
                    <div class="detail-item">
                        <label><%= t('users.expires') %></label>
                        <span class="value"><%= user.expireAt ? new Date(user.expireAt).toLocaleDateString(lang === 'en' ? 'en-US' : 'ru-RU') : t('users.forever') %></span>
                    </div>
                </div>
                
                <h3 class="section-title"><%= t('users.availableNodes') %> (<%= user.nodes?.length || 0 %>)</h3>
                <div class="nodes-list">
                    <% if (user.nodes && user.nodes.length > 0) { %>
                        <% user.nodes.forEach(node => { %>
                        <div class="node-badge">
                            <span class="node-name"><%= node.name %></span>
                            <span class="node-ip"><%= node.ip %></span>
                        </div>
                        <% }); %>
                    <% } else { %>
                        <span class="text-muted"><%= t('users.noNodes') %></span>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-4">
        <div class="card">
            <div class="card-header">
                <h2><%= t('common.actions') %></h2>
            </div>
            <div class="card-body">
                <div class="actions-list">
                    <% if (user.enabled) { %>
                    <button class="btn btn-warning btn-block" onclick="toggleUser(false)">
                        <%= t('users.disableUser') %>
                    </button>
                    <% } else { %>
                    <button class="btn btn-success btn-block" onclick="toggleUser(true)">
                        <%= t('users.enableUser') %>
                    </button>
                    <% } %>
                    
                    <button class="btn btn-block" onclick="copySubscription()">
                        ðŸ“‹ <%= t('users.copySubscription') %>
                    </button>
                    
                    <a href="<%= baseUrl %>/api/files/<%= user.subscriptionToken || user.userId %>" 
                       target="_blank" class="btn btn-block">
                        <%= t('users.openSubscription') %>
                    </a>
                    
                    <hr>
                    
                    <button class="btn btn-danger btn-block" onclick="deleteUser()">
                        <%= t('users.deleteUser') %>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card mt-2">
            <div class="card-header">
                <h2><%= t('users.subscriptionLink') %></h2>
            </div>
            <div class="card-body">
                <div id="qrcode" style="text-align:center;margin-bottom:12px;"></div>
                <p class="hint mb-1"><%= t('users.universalLink') %></p>
                <input type="text" readonly class="input-readonly" 
                       value="<%= baseUrl %>/api/files/<%= user.subscriptionToken || user.userId %>" id="subLink">
                <button class="btn btn-sm btn-block mt-1" onclick="copySubscription()"><%= t('common.copy') %></button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<script>
const userId = '<%= user.userId %>';
const i18n = {
    error: '<%= t("common.error") %>',
    confirmDelete: '<%= t("users.confirmDelete") %> ' + userId + '?',
    linkCopied: '<%= t("users.linkCopied") %>'
};

async function toggleUser(enabled) {
    const res = await fetch(`/api/users/${userId}/${enabled ? 'enable' : 'disable'}`, {
        method: 'POST',
        headers: { 'X-API-Key': window.API_KEY }
    });
    if (res.ok) location.reload();
    else alert(i18n.error);
}

async function deleteUser() {
    if (!confirm(i18n.confirmDelete)) return;
    
    const res = await fetch(`/api/users/${userId}`, {
        method: 'DELETE',
        headers: { 'X-API-Key': window.API_KEY }
    });
    if (res.ok) location.href = '/panel/users';
    else alert(i18n.error);
}

function copySubscription() {
    const link = document.getElementById('subLink').value;
    navigator.clipboard.writeText(link).then(() => {
        alert(i18n.linkCopied);
    }).catch(() => {
    document.getElementById('subLink').select();
    document.execCommand('copy');
    alert(i18n.linkCopied);
    });
}

const subUrl = document.getElementById('subLink').value;
QRCode.toCanvas(document.createElement('canvas'), subUrl, { width: 180, margin: 1 }, (err, canvas) => {
    if (!err) document.getElementById('qrcode').appendChild(canvas);
});
</script>
