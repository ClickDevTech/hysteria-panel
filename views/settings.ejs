<% if (message) { %>
<div class="alert alert-success"><%= message %></div>
<% } %>
<% if (error) { %>
<div class="alert alert-error"><%= error %></div>
<% } %>

<div class="row">
    <div class="col-6">
        <div class="card">
            <div class="card-header">
                <h2><%= t('settings.general') %></h2>
            </div>
            <div class="card-body">
                <div class="settings-list">
                    <div class="setting-item">
                        <label><%= t('settings.baseUrl') %></label>
                        <code><%= config.BASE_URL %></code>
                    </div>
                    <div class="setting-item">
                        <label><%= t('settings.port') %></label>
                        <code><%= config.PORT %></code>
                    </div>
                    <div class="setting-item">
                        <label><%= t('settings.mongodb') %></label>
                        <code><%= config.MONGO_URI.replace(/\/\/.*@/, '//***@') %></code>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-2">
            <div class="card-header">
                <h2><%= t('settings.systemSettings') %></h2>
            </div>
            <div class="card-body">
                <form method="POST" action="/panel/settings">
                    
                    <h4 style="margin-bottom: 0.75rem;"><%= t('settings.loadBalancing') %></h4>
                    <div class="settings-list" style="margin-bottom: 1.5rem;">
                        <label class="checkbox-label">
                            <input type="checkbox" name="loadBalancing.enabled" 
                                   <%= settings?.loadBalancing?.enabled ? 'checked' : '' %>>
                            <span><%= t('settings.loadBalancingEnabled') %></span>
                        </label>
                        <small class="hint" style="display: block; margin-top: 0.25rem;">
                            <%= t('settings.loadBalancingHint') %>
                        </small>
                        
                        <label class="checkbox-label" style="margin-top: 0.75rem;">
                            <input type="checkbox" name="loadBalancing.hideOverloaded" 
                                   <%= settings?.loadBalancing?.hideOverloaded ? 'checked' : '' %>>
                            <span><%= t('settings.hideOverloaded') %></span>
                        </label>
                        <small class="hint" style="display: block; margin-top: 0.25rem;">
                            <%= t('settings.hideOverloadedHint') %>
                        </small>
                    </div>
                    
                    <hr style="margin: 1rem 0; border-color: var(--border);">
                    
                    <h4 style="margin-bottom: 0.75rem;"><%= t('settings.deviceLimit') %></h4>
                    <div class="settings-grid" style="margin-bottom: 1rem;">
                        <div class="form-group">
                            <label for="deviceGracePeriod"><%= t('settings.gracePeriod') %></label>
                            <input type="number" name="deviceGracePeriod" id="deviceGracePeriod" 
                                   value="<%= settings?.deviceGracePeriod ?? 15 %>" min="1" max="60">
                            <small class="hint"><%= t('settings.gracePeriodHint') %></small>
                        </div>
                    </div>
                    <div class="alert" style="background: var(--bg-tertiary); border: 1px solid var(--border); padding: 12px; font-size: 13px;">
                        <strong><%= t('settings.howItWorks') %></strong> <%= t('settings.howItWorksDesc').replace('{minutes}', settings?.deviceGracePeriod ?? 15) %>
                    </div>
                    
                    <hr style="margin: 1rem 0; border-color: var(--border);">
                    
                    <h4 style="margin-bottom: 0.75rem;"><%= t('settings.caching') %></h4>
                    <div class="settings-grid" style="margin-bottom: 1rem;">
                        <div class="form-group">
                            <label for="cache.subscriptionTTL"><%= t('settings.subscriptionsTTL') %></label>
                            <input type="number" name="cache.subscriptionTTL" id="cache.subscriptionTTL" 
                                   value="<%= settings?.cache?.subscriptionTTL || 3600 %>" min="60" max="86400">
                            <small class="hint"><%= t('settings.subscriptionsTTLHint') %></small>
                        </div>
                        
                        <div class="form-group">
                            <label for="cache.userTTL"><%= t('settings.usersTTL') %></label>
                            <input type="number" name="cache.userTTL" id="cache.userTTL" 
                                   value="<%= settings?.cache?.userTTL || 900 %>" min="60" max="3600">
                            <small class="hint"><%= t('settings.usersTTLHint') %></small>
                        </div>
                        
                        <div class="form-group">
                            <label for="cache.onlineSessionsTTL"><%= t('settings.onlineSessionsTTL') %></label>
                            <input type="number" name="cache.onlineSessionsTTL" id="cache.onlineSessionsTTL" 
                                   value="<%= settings?.cache?.onlineSessionsTTL || 10 %>" min="5" max="60">
                            <small class="hint"><%= t('settings.onlineSessionsTTLHint') %></small>
                        </div>
                        
                        <div class="form-group">
                            <label for="cache.activeNodesTTL"><%= t('settings.activeNodesTTL') %></label>
                            <input type="number" name="cache.activeNodesTTL" id="cache.activeNodesTTL" 
                                   value="<%= settings?.cache?.activeNodesTTL || 30 %>" min="10" max="300">
                            <small class="hint"><%= t('settings.activeNodesTTLHint') %></small>
                        </div>
                    </div>
                    
                    <hr style="margin: 1rem 0; border-color: var(--border);">
                    
                    <h4 style="margin-bottom: 0.75rem;"><%= t('settings.rateLimiting') %></h4>
                    <div class="settings-grid" style="margin-bottom: 1rem;">
                        <div class="form-group">
                            <label for="rateLimit.subscriptionPerMinute"><%= t('settings.subscriptionsPerMinute') %></label>
                            <input type="number" name="rateLimit.subscriptionPerMinute" id="rateLimit.subscriptionPerMinute" 
                                   value="<%= settings?.rateLimit?.subscriptionPerMinute || 100 %>" min="10" max="1000">
                            <small class="hint"><%= t('settings.subscriptionsPerMinuteHint') %></small>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary"><%= t('settings.saveAllSettings') %></button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-6">
        <div class="card">
            <div class="card-header">
                <h2><%= t('settings.security') %></h2>
            </div>
            <div class="card-body">
                <div class="settings-list">
                    <div class="setting-item">
                        <label><%= t('settings.administrator') %></label>
                        <span><%= admin?.username || 'N/A' %></span>
                    </div>
                    <div class="setting-item">
                        <label><%= t('settings.lastLogin') %></label>
                        <span><%= admin?.lastLogin ? new Date(admin.lastLogin).toLocaleString(lang === 'en' ? 'en-US' : 'ru-RU') : t('settings.never') %></span>
                    </div>
                    <div class="setting-item">
                        <label><%= t('settings.ipWhitelist') %></label>
                        <span><%= config.PANEL_IP_WHITELIST || t('settings.ipWhitelistDisabled') %></span>
                    </div>
                </div>
                
                <hr style="margin: 1rem 0; border-color: var(--border);">
                
                <h4 style="margin-bottom: 0.5rem;"><%= t('settings.changePassword') %></h4>
                <form method="POST" action="/panel/settings/password" class="compact-form">
                    <div class="form-group">
                        <input type="password" name="currentPassword" placeholder="<%= t('settings.currentPassword') %>" required>
                    </div>
                    <div class="form-group">
                        <input type="password" name="newPassword" placeholder="<%= t('settings.newPassword') %>" minlength="6" required>
                    </div>
                    <div class="form-group">
                        <input type="password" name="confirmPassword" placeholder="<%= t('settings.confirmPassword') %>" minlength="6" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm"><%= t('settings.changePasswordBtn') %></button>
                </form>
            </div>
        </div>
        
        <div class="card mt-2">
            <div class="card-header">
                <h2><%= t('settings.sslCertificate') %></h2>
            </div>
            <div class="card-body">
                <% if (ssl.enabled) { %>
                <div class="alert alert-success">
                    <strong><%= t('settings.httpsActive') %></strong>
                    <p>Domain: <%= ssl.domain %></p>
                    <p><%= t('settings.letsEncryptAuto') %></p>
                </div>
                <% } else { %>
                <div class="alert alert-warning">
                    <strong><%= t('settings.httpMode') %></strong>
                    <p><%= t('settings.httpModeHint') %></p>
                    <pre>PANEL_DOMAIN=panel.example.com
ACME_EMAIL=admin@example.com</pre>
                </div>
                <% } %>
            </div>
        </div>
        
        <div class="card mt-2">
            <div class="card-header">
                <h2><%= t('settings.systemStatus') %></h2>
            </div>
            <div class="card-body">
                <div class="settings-list">
                    <div class="setting-item">
                        <label>Uptime</label>
                        <span><%= Math.floor(process.uptime() / 3600) %>h <%= Math.floor((process.uptime() % 3600) / 60) %>m</span>
                    </div>
                    <div class="setting-item">
                        <label>Memory</label>
                        <span><%= Math.round(process.memoryUsage().heapUsed / 1024 / 1024) %> MB</span>
                    </div>
                    <div class="setting-item">
                        <label>Node.js</label>
                        <span><%= process.version %></span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-2">
            <div class="card-header">
                <h2><%= t('settings.cacheManagement') %></h2>
            </div>
            <div class="card-body">
                <h4 style="margin-bottom: 0.5rem;"><%= t('settings.flushCache') %></h4>
                <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 1rem;">
                    <%= t('settings.flushCacheDesc') %>
                </p>
                <button class="btn btn-warning btn-sm" onclick="flushCache()">
                    <%= t('settings.flushCacheBtn') %>
                </button>
            </div>
        </div>
        
        <div class="card mt-2">
            <div class="card-header">
                <h2><%= t('settings.dangerZone') %></h2>
            </div>
            <div class="card-body">
                <h4 style="margin-bottom: 0.5rem;"><%= t('settings.resetStats') || 'Сброс статистики' %></h4>
                <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 1rem;">
                    <%= t('settings.resetStatsDesc') || 'Удалить все исторические данные статистики (графики онлайна, трафика, нод).' %>
                </p>
                <button class="btn btn-warning btn-sm" onclick="resetStats()">
                    <%= t('settings.resetStatsBtn') || 'Очистить статистику' %>
                </button>
                
                <hr style="margin: 1.5rem 0; border-color: var(--border);">
                
                <h4 style="margin-bottom: 0.5rem;"><%= t('settings.resetTrafficCounter') %></h4>
                <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 1rem;">
                    <%= t('settings.resetTrafficDesc') %>
                </p>
                <button class="btn btn-danger btn-sm" onclick="resetTraffic()">
                    <%= t('settings.resetAllTraffic') %>
                </button>
            </div>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
const i18n = {
    resetConfirm: <%- JSON.stringify(t("settings.resetConfirm")) %>,
    resetConfirmFinal: <%- JSON.stringify(t("settings.resetConfirmFinal")) %>,
    resetting: <%- JSON.stringify(t("settings.resetting")) %>,
    resetAllTraffic: <%- JSON.stringify(t("settings.resetAllTraffic")) %>,
    trafficReset: <%- JSON.stringify(t("settings.trafficReset")) %>,
    error: <%- JSON.stringify(t("common.error")) %>,
    flushCacheConfirm: <%- JSON.stringify(t("settings.flushCacheConfirm")) %>,
    flushing: <%- JSON.stringify(t("settings.flushing")) %>,
    flushCacheBtn: <%- JSON.stringify(t("settings.flushCacheBtn")) %>,
    cacheFlushed: <%- JSON.stringify(t("settings.cacheFlushed")) %>,
    resetStatsConfirm: <%- JSON.stringify(t("settings.resetStatsConfirm") || "Удалить всю историю статистики?") %>,
    resetStatsBtn: <%- JSON.stringify(t("settings.resetStatsBtn") || "Очистить статистику") %>,
    statsReset: <%- JSON.stringify(t("settings.statsReset") || "Статистика очищена ({count} записей)") %>
};

async function resetStats() {
    if (!confirm(i18n.resetStatsConfirm)) {
        return;
    }
    
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = i18n.resetting;
    
    try {
        const res = await fetch('/panel/settings/reset-stats', {
            method: 'POST',
            credentials: 'include'
        });
        
        const data = await res.json();
        
        if (data.success) {
            showToast(i18n.statsReset.replace('{count}', data.count), 'success');
            btn.disabled = false;
            btn.textContent = i18n.resetStatsBtn;
        } else {
            showToast(i18n.error + ': ' + (data.error || 'unknown'), 'error');
            btn.disabled = false;
            btn.textContent = i18n.resetStatsBtn;
        }
    } catch (e) {
        showToast(i18n.error, 'error');
        btn.disabled = false;
        btn.textContent = i18n.resetStatsBtn;
    }
}

async function flushCache() {
    if (!confirm(i18n.flushCacheConfirm)) {
        return;
    }
    
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = i18n.flushing;
    
    try {
        const res = await fetch('/panel/settings/flush-cache', {
            method: 'POST',
            credentials: 'include'
        });
        
        const data = await res.json();
        
        if (data.success) {
            showToast(i18n.cacheFlushed, 'success');
            btn.disabled = false;
            btn.textContent = i18n.flushCacheBtn;
        } else {
            showToast(i18n.error + ': ' + (data.error || 'unknown'), 'error');
            btn.disabled = false;
            btn.textContent = i18n.flushCacheBtn;
        }
    } catch (e) {
        showToast(i18n.error, 'error');
        btn.disabled = false;
        btn.textContent = i18n.flushCacheBtn;
    }
}

async function resetTraffic() {
    if (!confirm(i18n.resetConfirm)) {
        return;
    }
    
    if (!confirm(i18n.resetConfirmFinal)) {
        return;
    }
    
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = i18n.resetting;
    
    try {
        const res = await fetch('/panel/settings/reset-traffic', {
            method: 'POST',
            credentials: 'include'
        });
        
        const data = await res.json();
        
        if (data.success) {
            showToast(i18n.trafficReset.replace('{count}', data.count), 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(i18n.error + ': ' + (data.error || 'unknown'), 'error');
            btn.disabled = false;
            btn.textContent = i18n.resetAllTraffic;
        }
    } catch (e) {
        showToast(i18n.error, 'error');
        btn.disabled = false;
        btn.textContent = i18n.resetAllTraffic;
    }
}

function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast show ' + type;
    setTimeout(() => toast.className = 'toast', 3000);
}
</script>
