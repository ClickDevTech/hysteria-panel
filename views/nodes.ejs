<div class="page-header">
    <div class="page-header-left">
        <span class="results-count"><%= t('common.total') %>: <%= nodes.length %></span>
    </div>
    <a href="/panel/nodes/add" class="btn btn-primary">+ <%= t('nodes.addNode') %></a>
</div>

<div class="card">
    <div class="card-body no-padding">
        <table class="table">
            <thead>
                <tr>
                    <th><%= t('common.name') %></th>
                    <th><%= t('common.server') %></th>
                    <th><%= t('common.ports') %></th>
                    <th><%= t('common.status') %></th>
                    <th><%= t('common.online') %></th>
                    <th><%= t('nodes.groups') %></th>
                    <th><%= t('common.actions') %></th>
                </tr>
            </thead>
            <tbody>
                <% if (nodes.length === 0) { %>
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        <div class="empty-state">
                            <span class="empty-icon">üñ•Ô∏è</span>
                            <p><%= t('nodes.noNodes') %></p>
                            <a href="/panel/nodes/add" class="btn btn-primary"><%= t('nodes.addFirstNode') %></a>
                        </div>
                    </td>
                </tr>
                <% } %>
                <% nodes.forEach(node => { %>
                <tr>
                    <td>
                        <strong><%= node.name %></strong>
                        <% if (node.domain) { %>
                        <br><small class="text-muted"><%= node.domain %></small>
                        <% } %>
                    </td>
                    <td><code><%= node.ip %></code></td>
                    <td>
                        <code><%= node.port %></code>
                        <% if (node.portRange) { %>
                        <br><small class="text-muted">hop: <%= node.portRange %></small>
                        <% } %>
                    </td>
                    <td>
                        <span class="badge badge-<%= node.status === 'online' ? 'success' : (node.status === 'error' ? 'danger' : 'warning') %>">
                            <%= node.status %>
                        </span>
                        <% if (!node.active) { %>
                        <span class="badge badge-secondary"><%= t('nodes.off') %></span>
                        <% } %>
                    </td>
                    <td>
                        <span class="<%= node.maxOnlineUsers && node.onlineUsers >= node.maxOnlineUsers ? 'text-danger' : '' %>">
                            <%= node.onlineUsers || 0 %><% if (node.maxOnlineUsers) { %>/<%= node.maxOnlineUsers %><% } %>
                        </span>
                    </td>
                    <td>
                        <% if (node.groups && node.groups.length > 0) { %>
                            <% node.groups.slice(0,2).forEach(group => { %>
                                <span class="group-tag-sm" style="background: <%= group.color %>20; border-color: <%= group.color %>; color: <%= group.color %>">
                                    <%= group.name %>
                                </span>
                            <% }); %>
                            <% if (node.groups.length > 2) { %>
                                <span class="group-more">+<%= node.groups.length - 2 %></span>
                            <% } %>
                        <% } else { %>
                            <span class="text-muted"><%= t('common.all') %></span>
                        <% } %>
                    </td>
                    <td>
                        <div class="btn-group">
                            <a href="/panel/nodes/<%= node._id %>" class="btn btn-sm"><%= t('common.edit') %></a>
                            <button class="btn btn-sm btn-danger" onclick="deleteNode('<%= node._id %>')"><%= t('common.delete') %></button>
                        </div>
                    </td>
                </tr>
                <% }); %>
            </tbody>
        </table>
    </div>
</div>

<script>
const i18n = {
    confirmDelete: '<%= t("nodes.confirmDelete") %>',
    deleteError: '<%= t("nodes.deleteError") %>'
};

async function deleteNode(id) {
    if (!confirm(i18n.confirmDelete)) return;
    
    const res = await fetch(`/api/nodes/${id}`, {
        method: 'DELETE',
        headers: { 'X-API-Key': window.API_KEY }
    });
    
    if (res.ok) {
        location.reload();
    } else {
        alert(i18n.deleteError);
    }
}
</script>
